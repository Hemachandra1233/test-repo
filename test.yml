# Step 1: Compute whether to publish
- script: |
    cd $(System.DefaultWorkingDirectory)/${{ parameters.package }}
    
    # Get local version
    LOCAL_VERSION=$(npm pkg get version | tr -d '"')
    echo "Local version: $LOCAL_VERSION"

    # Get latest version from ADO feed
    ADO_VERSION=$(npm view @usf/${{ parameters.package }} version --registry https://pkgs.dev.azure.com/hemachandrash1019/mvn-example/_packaging/usf-packages/npm/registry/ || echo "0.0.0")
    echo "ADO version: $ADO_VERSION"

    # Compare versions
    if [ "$(printf '%s\n' "$LOCAL_VERSION" "$ADO_VERSION" | sort -V | tail -n1)" = "$LOCAL_VERSION" ] && [ "$LOCAL_VERSION" != "$ADO_VERSION" ]; then
      echo "##vso[task.setvariable variable=ShouldPublish]true"
      echo "Publishing required: true"
    else
      echo "##vso[task.setvariable variable=ShouldPublish]false"
      echo "Publishing required: false"
    fi
  displayName: 'Check if package should be published'

# Step 2: Conditional publish
- script: |
    cd $(System.DefaultWorkingDirectory)/${{ parameters.package }}
    npm publish --registry https://pkgs.dev.azure.com/hemachandrash1019/mvn-example/_packaging/usf-packages/npm/registry/
  displayName: 'Publish package'
  condition: eq(variables['ShouldPublish'], 'true')
